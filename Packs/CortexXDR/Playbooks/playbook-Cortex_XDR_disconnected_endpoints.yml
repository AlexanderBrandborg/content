description: |
  A Job to periodically query disconnected Cortex XDR endpoints with a provided last seen time range playbook input.
  The Collected data, if found will be generated to a CSV report, including a detailed list of the disconnected endpoints.
  The report will be sent to the recipient's provided email addresses in the playbook input.
  The playbook includes an incident type with a dedicated layout to visualize the collected data.
  To set the job correctly, you will need to.
  1. Create a new recurring job.
  2. Set the recurring schedule.
  3. Add a name.
  4. Set type to Cortex XDR disconnected endpoints.
  5. Set this playbook as the job playbook.

  The scheduled run time and the timestamp relative date should be identical,
  If the job is recurring every 7 days, the time range should be 7 days as well.
id: 'Cortex XDR disconnected endpoints'
inputs:
- description: 'Last seen start date, in relative timestamp - "1 Day" or  "7 days" '
  key: LastSeenStartDate
  playbookInputQuery:
  required: false
  value:
    simple: 
- description: "Last seen end date, in relative timestamp - \"1 Day\" or  \"7 days\"\
    \ \nFor the current day use \"0 days\""
  key: LastSeenEndDate
  playbookInputQuery:
  required: false
  value:
    simple: 
- description: Email addresses to send the disconnected endpoints report.
  key: Email
  playbookInputQuery:
  required: false
  value:
    simple: 
- description: 'Body for the report email message. '
  key: MessageBody
  playbookInputQuery:
  required: false
  value:
    simple: |-
      This message contains an automatically generated report by Cortex XSOAR, including a list of  disconnected Cortex XDR endpoints.
      Please investigate and remediate according to the organization's policy.
name: 'Cortex XDR disconnected endpoints'
outputs: []
starttaskid: "0"
tasks:
  "0":
    id: "0"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "1"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: a7e4284c-c498-4306-8cfd-89a9072a8cd8
      iscommand: false
      name: ""
      version: -1
      description: ''
    taskid: a7e4284c-c498-4306-8cfd-89a9072a8cd8
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 40
        }
      }
  "1":
    id: "1"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      alias_name: {}
      dist_name: {}
      endpoint_id_list: {}
      first_seen_gte: {}
      first_seen_lte: {}
      group_name: {}
      hostname: {}
      ip_list: {}
      isolate: {}
      last_seen_gte:
        complex:
          root: inputs.LastSeenStartDate
      last_seen_lte:
        complex:
          root: inputs.LastSeenEndDate
      limit: {}
      page: {}
      platform: {}
      sort_by: {}
      sort_order: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Gets a list of endpoints, according to the passed filters. If there
        are no filters, all endpoints are returned. Filtering by multiple fields will
        be concatenated using the AND condition (OR is not supported). The maximum
        result set size is 100. Offset is the zero-based number of the endpoint from
        the start of the result set (start by counting from 0).
      id: d8e239ed-2461-42d6-8691-b724318df91f
      iscommand: true
      name: 'Get XDR disconnected endpoints '
      script: '|||xdr-get-endpoints'
      type: regular
      version: -1
    taskid: d8e239ed-2461-42d6-8691-b724318df91f
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 205
        }
      }
  "2":
    id: "2"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "9"
    note: false
    quietmode: 0
    scriptarguments:
      csvArray:
        complex:
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
              operator: isEqualString
              right:
                value:
                  simple: LOST
          root: PaloAltoNetworksXDR.Endpoint
      fileName:
        simple: Disconnected XDR endpoints.csv
      headers: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Export the given array to a CSV file.
      id: a1e2abeb-82cb-44c7-8889-bad92bf8635b
      iscommand: false
      name: Generate a CSV report for disconnected XDR endpoints
      script: ExportToCSV
      tags:
      - Endpoint report
      type: regular
      version: -1
    taskid: a1e2abeb-82cb-44c7-8889-bad92bf8635b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 645
        }
      }
  "3":
    id: "3"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    scriptarguments:
      additionalHeader: {}
      attachCIDs: {}
      attachIDs:
        complex:
          accessor: EntryID
          root: File
      attachNames: {}
      bcc: {}
      body: {}
      cc: {}
      from: {}
      htmlBody:
        complex:
          root: inputs.MessageBody
      replyTo: {}
      subject:
        simple: 'CortexXDR Discconcted endpoint '
      templateParams: {}
      to:
        complex:
          root: inputs.Email
      transientFile: {}
      transientFileCID: {}
      transientFileContent: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Sends an mail using Gmail/EWS.
      id: beca6477-7914-43b2-8643-4b1450aeb9ad
      iscommand: true
      name: Mail disconnected endpoints report
      script: '|||send-mail'
      type: regular
      version: -1
    taskid: beca6477-7914-43b2-8643-4b1450aeb9ad
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 995
        }
      }
  "4":
    id: "4"
    ignoreworker: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 2bd03c57-4ef2-4e6f-8c19-70d296029122
      iscommand: false
      name: Done
      type: title
      version: -1
      description: ''
    taskid: 2bd03c57-4ef2-4e6f-8c19-70d296029122
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 1860
        }
      }
  "5":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Endpoint
          operator: isNotEmpty
      - - left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
          operator: isEqualString
          right:
            value:
              simple: LOST
      label: "yes"
    id: "5"
    ignoreworker: false
    nexttasks:
      '#default#':
      - "4"
      "yes":
      - "2"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: ''''''
      id: 2383bf6b-0fb1-49cf-8993-2063413aa608
      iscommand: false
      name: Was an disconnected endpoint found?
      type: condition
      version: -1
    taskid: 2383bf6b-0fb1-49cf-8993-2063413aa608
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 390
        }
      }
  "6":
    id: "6"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "8"
    note: false
    quietmode: 0
    scriptarguments:
      accountid: {}
      accountname: {}
      addLabels: {}
      agentid: {}
      alertid: {}
      alertname: {}
      app: {}
      appendMultiSelect: {}
      applicationid: {}
      applicationname: {}
      assetid: {}
      assigneduser: {}
      assignmentgroup: {}
      attachmentcount: {}
      attachmentextension: {}
      attachmenthash: {}
      attachmentid: {}
      attachmentname: {}
      attachmentsize: {}
      attachmenttype: {}
      blockedaction: {}
      bugtraq: {}
      caller: {}
      categorycount: {}
      city: {}
      closeNotes: {}
      closeReason: {}
      closetime: {}
      closingreason: {}
      closinguser: {}
      cloudservice: {}
      commandline: {}
      compliancenotes: {}
      costcenter: {}
      costcentercode: {}
      country: {}
      countryname: {}
      createddatefailedincidents: {}
      criticalassets: {}
      customFields: {}
      cve: {}
      cvss: {}
      cvssavailabilityrequirement: {}
      cvsscollateraldamagepotential: {}
      cvssconfidentialityrequirement: {}
      cvssintegrityrequirement: {}
      dbotMirrorDirection: {}
      dbotMirrorId: {}
      dbotMirrorInstance: {}
      dbotMirrorTags: {}
      dbotprediction: {}
      dbotpredictionprobability: {}
      dbottextsuggestionhighlighted: {}
      deleteEmptyField: {}
      department: {}
      dest: {}
      desthostname: {}
      destinationgeolocation: {}
      destinationhostname: {}
      destinationip: {}
      destinationips: {}
      destinationipv6: {}
      destinationmacaddress: {}
      destinationnetwork: {}
      destinationport: {}
      destntdomain: {}
      destos: {}
      details: {}
      detectedexternalhosts: {}
      detectedexternalips: {}
      detectedinternalhosts: {}
      detectedinternalips: {}
      detectedusers: {}
      detectionendtime: {}
      detectionid: {}
      detectionupdatetime: {}
      detectionurl: {}
      deviceexternalip: {}
      devicehash: {}
      deviceid: {}
      devicelocalip: {}
      devicemodel: {}
      devicename: {}
      devicetime: {}
      displayname: {}
      dnsname: {}
      dstports: {}
      duration: {}
      email: {}
      emailauthenticitycheck: {}
      emailbcc: {}
      emailbody: {}
      emailbodyformat: {}
      emailbodyhtml: {}
      emailcc: {}
      emailclassification: {}
      emailclientname: {}
      emailfrom: {}
      emailheaders: {}
      emailhtml: {}
      emailhtmlimage: {}
      emailinreplyto: {}
      emailkeywords: {}
      emaillabels: {}
      emaillatestmessage: {}
      emailmessageid: {}
      emailreceived: {}
      emailreplyto: {}
      emailreturnpath: {}
      emailsenderip: {}
      emailsize: {}
      emailsource: {}
      emailsubject: {}
      emailto: {}
      emailtocount: {}
      emailurlclicked: {}
      employeedisplayname: {}
      employeeemail: {}
      employeemanageremail: {}
      errorcode: {}
      errormessage: {}
      escalation: {}
      eventaction: {}
      eventdescriptions: {}
      eventid: {}
      eventnames: {}
      events: {}
      eventtype: {}
      externaladdresses: {}
      failedincidentscreateddate: {}
      filehash: {}
      filename: {}
      filepath: {}
      filesize: {}
      firstname: {}
      firstseen: {}
      followup: {}
      givenname: {}
      helloworldid: {}
      helloworldstatus: {}
      helloworldtype: {}
      highlevelcategories: {}
      hostname: {}
      hosts: {}
      id: {}
      incomingmirrorerror: {}
      infectedhosts: {}
      integrationscategories: {}
      integrationsfailedcategories: {}
      integrationstestgrid: {}
      internaladdresses: {}
      investigationstage: {}
      isolated: {}
      jobcode: {}
      jobfamily: {}
      jobfunction: {}
      labels: {}
      lastmirroredintime: {}
      lastmodifiedby: {}
      lastmodifiedon: {}
      lastname: {}
      lastseen: {}
      lastupdatetime: {}
      leadership: {}
      listofrulesevent: {}
      location: {}
      locationregion: {}
      logsource: {}
      logsourcename: {}
      logsourcetype: {}
      lowlevelcategoriesevents: {}
      macaddress: {}
      maliciousbehavior: {}
      malwarefamily: {}
      malwarename: {}
      manageremailaddress: {}
      managername: {}
      md5: {}
      mobiledevicemodel: {}
      mobilephone: {}
      name: {}
      numberofentriesiderrors: {}
      numberoffailedincidents: {}
      numberoflogsources: {}
      occurred: {}
      os: {}
      osversion: {}
      outgoingmirrorerror: {}
      owner: {}
      parentprocessid: {}
      personalemail: {}
      phase: {}
      phishingsubtype: {}
      phonenumber: {}
      pid: {}
      playbooknameswithfailedtasks: {}
      playbooksfailedcommands: {}
      playbookswithfailedtasks: {}
      playbooktaskserrors: {}
      policydeleted: {}
      policydescription: {}
      policydetails: {}
      policyid: {}
      policyrecommendation: {}
      policyremediable: {}
      policyseverity: {}
      policytype: {}
      postnatdestinationip: {}
      postnatdestinationport: {}
      postnatsourceip: {}
      postnatsourceport: {}
      prenatdestinationport: {}
      prenatsourceip: {}
      prenatsourceport: {}
      protocol: {}
      protocolevent: {}
      protocols: {}
      quarantined: {}
      ransomwareapproximatenumberofencryptedendpoints: {}
      ransomwarecryptocurrencyaddress: {}
      ransomwarecryptocurrencyaddresstype: {}
      ransomwaredataencryptionstatus: {}
      ransomwareemail: {}
      ransomwareencryptedfileowner: {}
      ransomwarenote: {}
      ransomwareonionaddress: {}
      ransomwarerecoverytool: {}
      ransomwarestrain: {}
      rating: {}
      rawevent: {}
      region: {}
      regionid: {}
      replacePlaybook: {}
      reporteremailaddress: {}
      resourceid: {}
      resourcename: {}
      resourcetype: {}
      riskrating: {}
      riskscore: {}
      roles: {}
      samaccountname: {}
      severity: {}
      sha1: {}
      sha256: {}
      sha512: {}
      signature: {}
      similarincident: {}
      skuname: {}
      skutier: {}
      sla: {}
      slaField: {}
      sourcegeolocation: {}
      sourcehostname: {}
      sourceip: {}
      sourceips: {}
      sourceipv6: {}
      sourcemacaddress: {}
      sourcenetwork: {}
      sourceport: {}
      sourceusername: {}
      src: {}
      srchostname: {}
      srcntdomain: {}
      srcos: {}
      srcports: {}
      srcuser: {}
      starttime: {}
      state: {}
      streetaddress: {}
      subcategory: {}
      subtype: {}
      surname: {}
      systems: {}
      technicalowner: {}
      technicalownercontact: {}
      technicaluser: {}
      tenantname: {}
      terminatedaction: {}
      threatactor: {}
      ticketcloseddate: {}
      ticketnumber: {}
      ticketopeneddate: {}
      title: {}
      totalfailedinstances: {}
      totalgoodinstances: {}
      totalinstances: {}
      trafficdirection: {}
      triggeredsecurityprofile: {}
      type: {}
      unassignedincidents: {}
      unhealthyendpoints: {}
      uniqueports: {}
      urlsslverification: {}
      user: {}
      useraccountcontrol: {}
      userid: {}
      username: {}
      usernames: {}
      users: {}
      vendorid: {}
      vendorproduct: {}
      vulnerabilitycategory: {}
      workphone: {}
      xdralertcount: {}
      xdralerts: {}
      xdrassigneduseremail: {}
      xdrassigneduserprettyname: {}
      xdrdescription: {}
      xdrdetectiontime: {}
      xdrdevicecontrolviolations: {}
      xdrfileartifacts: {}
      xdrhighseverityalertcount: {}
      xdrhostcount:
        complex:
          accessor: endpoint_name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
              operator: isEqualString
              right:
                value:
                  simple: LOST
          root: PaloAltoNetworksXDR.Endpoint
          transformers:
          - operator: count
      xdrincidentid: {}
      xdrlowseverityalertcount: {}
      xdrmanualseverity: {}
      xdrmediumseverityalertcount: {}
      xdrmodificationtime: {}
      xdrnetworkartifacts: {}
      xdrnotes: {}
      xdrresolvecomment: {}
      xdrstatus: {}
      xdrstatusv2: {}
      xdrurl: {}
      xdrusercount:
        complex:
          accessor: users
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
              operator: isEqualString
              right:
                value:
                  simple: LOST
          root: PaloAltoNetworksXDR.Endpoint
          transformers:
          - operator: count
      zipcode: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Count the users and hosts involved in the incidents and insert
        the amount in the incident field,
      id: ee4edfa9-92e4-423a-8944-61b0fec7d80d
      iscommand: true
      name: Count involved users and hosts
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: ee4edfa9-92e4-423a-8944-61b0fec7d80d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 1190
        }
      }
  "7":
    id: "7"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      columns:
        simple: Endpoint Name,Endpoint Status,Endpoint OS,Endpoint ID,Endpoint Last
          Seen
      context_path:
        simple: XDR.DisconnectedEndpoints
      grid_id:
        simple: xdrdisconnectedendpoints
      keys:
        simple: endpoint_name,endpoint_status,os_type,endpoint_id,last_seen
      overwrite: {}
      sort_by: {}
      unpack_nested_elements: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Creates a grid table from items or key-value pairs.
      id: fd9d22ad-f557-46a5-83a9-8f5e9747acd9
      iscommand: false
      name: Set endpoints grid
      script: SetGridField
      type: regular
      version: -1
    taskid: fd9d22ad-f557-46a5-83a9-8f5e9747acd9
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 1510
        }
      }
  "8":
    id: "8"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "7"
    note: false
    quietmode: 0
    scriptarguments:
      append: {}
      key:
        simple: XDR.DisconnectedEndpoints
      stringify: {}
      value:
        complex:
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
              operator: isEqualString
              right:
                value:
                  simple: LOST
          root: PaloAltoNetworksXDR.Endpoint
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 13f7548d-d5c5-4195-81ba-6ad754007635
      iscommand: false
      name: Set disconnected endpoints
      script: Set
      type: regular
      version: -1
    taskid: 13f7548d-d5c5-4195-81ba-6ad754007635
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 1345
        }
      }
  "9":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.Email
          operator: isNotEmpty
      label: "yes"
    id: "9"
    ignoreworker: false
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "3"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: ''
      id: 1071226a-0453-43bd-8ff1-5f5f29c0226f
      iscommand: false
      name: Email report?
      type: condition
      version: -1
    taskid: 1071226a-0453-43bd-8ff1-5f5f29c0226f
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 780
        }
      }
  "10":
    id: "10"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "4"
    note: false
    quietmode: 0
    scriptarguments:
      assetid: {}
      closeNotes: {}
      closeReason: {}
      emailclassification: {}
      id: {}
      incomingmirrorerror: {}
      outgoingmirrorerror: {}
      phishingsubtype: {}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: commands.local.cmd.close.inv
      id: bbb69d07-d941-417b-8369-604838e476cc
      iscommand: true
      name: Close job
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: bbb69d07-d941-417b-8369-604838e476cc
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 1670
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "5_2_yes": 0.55,
      "5_4_#default#": 0.1
    },
    "paper": {
      "dimensions": {
        "height": 1885,
        "width": 380,
        "x": 162.5,
        "y": 40
      }
    }
  }
tests:
- Cortex XDR disconnected endpoints Test
fromversion: 5.5.0
